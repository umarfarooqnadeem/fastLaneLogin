version: 2.1

# Define commands to be used in jobs.
commands:
  # Decode and build credentials (e.g., provisioning profiles, certificates)
  decode-and-build-credentials:
    description: "Decode and build credentials"
    steps:
      - run:
          name: Decode credentials
          command: |
            echo "$CERTIFICATES_BASE64" | base64 --decode > certificates/certificates.p12
            echo "$PROVISIONING_PROFILE_BASE64" | base64 --decode > provisioning/provisioning_profile.mobileprovision

  # Increment build number
  increment-build-number:
    description: "Increment build number"
    steps:
      - run:
          name: Increment build number
          command: |
            # Get the current build number from the Info.plist
            build_number=$(agvtool what-version -terse)
            # Increment the build number
            new_build_number=$((build_number + 1))
            # Set the new build number
            agvtool new-marketing-version $new_build_number

# Define executors directly
executors:
  macos:
    docker:
      - image: circleci/macos:latest

# Define jobs to be invoked later in a workflow.
jobs:
  # Build and deploy release variant
  build-release-and-deploy:
    executor:
      name: macos
    steps:
      - checkout
      - run:
          name: Install dependencies
          command: bundle install
      - decode-and-build-credentials
      - increment-build-number
      - run:
          name: Build release variant
          command: bundle exec fastlane build_release
      - store_artifacts:
          path: fastlane/release-artifacts
      - run:
          name: Upload to TestFlight
          command: bundle exec fastlane testflight

# Define workflows to manage job execution.
workflows:
  release:
    jobs:
      - build-release-and-deploy:
          filters:
            branches:
              only:
                - main  # Branch for release builds
